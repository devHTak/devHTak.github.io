---
layout: post
title: Kafka 스트림즈
summary: Kafka
author: devhtak
date: '2022-10-29 14:41:00 +0900'
category: mq
---

#### 카프카 스트림즈

- 토픽에 적재된 데이터를 상태기반(stateful) 또는 비상태기반(stateless)으로 실시간 변환하여 다른 토픽에 적재하는 라이브러리
- 자바 기반 스트림즈 애플리케이션은 카프카 클러스터와 완벽하게 호환되며 스트림 처리에 필요한 편리한 기능들(신규 토픽 생성, 상태 저장, 데이터 조인 등)을 제공
- 처리 안전성이 뛰어남
  - exactly once
  - fault tolerant system

- 스트림즈 애플리케이션은 내부적으로 스레드를 1개 이상 생성할 수 있으며, 스레드는 1개 이상의 태스크를 가진다
  - 태스크는 스트림즈 애플리케이션을 실행할 때 생기는 데이터 처리 최소 단위
  - 3개의 파티션으로 이루어진 토픽을 처리하는 애플리케이션을 실행하면 3개의 태스크가 생긴다
- 병렬처리를 위해서는 파티션과 스트림즈 스레드(또는 프로세스) 개수를 늘림으로써 처리량을 늘릴 수 있다

- 프로듀서/컨슈머 조합을 사용하지 않고 스트림즈를 사용하는 이유
  - 스트림 데이터 처리에 필요한 다양한 기능을 스트림즈 DSL 로 제공하여 필요하다면 프로세서 API를 사용하여 기능을 확장할 수 있다
  - 물론 프로듀서, 컨슈머를 조합하여 스트림즈가 제공하는 기능과 유사하게 만들 수 있다
    - 하지만, 스트림즈 라이브러리를 통해 단 한 번의 데이터 처리, 장애 허용 시스템 등의 특징들은 프로듀서/컨슈머 조합으로 완벽하게 구현하기 어렵다
    - 스트림즈가 제공하지 못하는 기능을 구현할 때에는 사용하는 것이 좋다
      - 소스 토픽(사용하는 토픽)과 싱크 토픽(저장하는 토픽)의 카프카 클러스더가 서로 다른 경우

- 토폴로지
  - 토폴로지란 2개 이상의 노드와 선으로 이루어진 집합을 뜻하며, 링형, 트리형, 성형 등이 있다
    - 스트림즈에서 사용하는 토폴로지는 트리 형태와 유사
  - 카프카 스트림즈에서는 토폴로지들을 이루는 노드를 하나의 프로세서라고 부르며 노드를 이은 선을 스트림이라고 부른다
  - 프로세서에는 소스 프로세서, 스트림 프로세서, 싱크 프로세서 3가지가 있다
    - 소스 프로세서: 데이터를 처리하기 위해 최초로 선언하는 노드로 하나 이상의 토픽에서 데이터를 가져오는 역할
    - 스트림 프로세서: 다른 프로세서가 반환한 데이터를 처리하는 역할
    - 싱크 프로세서: 데이터를 특정 카프카 토픽으로 저장하는 역할

- 개발 방법
  - 스트림즈 DSL로 구현
    - 메시지 값을 기반으로 토픽 분기처리
    - 지난 10분 간 들어온 데이터 개수 집계
    - 토픽과 다른 토픽의 결합으로 새로운 데이터 생성
  - 프로세서 API 로 구현
    - 메시지 값의 종류에 따라 토픽을 가변적으로 전송
    - 일정한 시간 간격으로 데이터 처리

#### 스트림즈 DSL

- 레코드 흐름 추상화 개념
  
  <img width="610" alt="image" src="https://user-images.githubusercontent.com/42403023/198834882-f0eee15a-0aaf-4bc0-aa97-64cf87f1be78.png">

  - 이미지 출처: https://techannotation.wordpress.com/2019/06/24/apache-kafka-stream-dealing-with-data/
  
  - KStream
    - 메시지 키와 값으로 구성되어 있으며 모든 레코드가 출력된다
    
  - KTable
    - 메시지 키를 기준으로 묶어서 사용하며 새로운 데이터를 적재할 때 동일한 메시지 키가 있을 때에는 데이트가 업데이트 된다
    
  - GlobalKTable
    - KTable로 선언된 토픽은 1개 파티션이 1개 태스크에 할당되어 사용되고, GlobalKTable로 선언된 토픽은 모든 파티션 데이터가 각 태스크에 할당되어 사용된다는 차이점이 있다
    - 코파티셔닝
      - KStream, KTable 데이터 조인할 때, 2개 데이터의 파티션 개수가 동일하고 파티셔닝 전략을 동일하게 맞추는 작업
      - 파티션 개수가 동일하고 파티셔닝 전략이 같은 경우, 동일한 메시지 키를 가진 데이터가 동일한 태스크에 들어가는 것을 보장한다, 이를 통해 조인을 수행할 수 있다
      - 문제는 파티션 개수가 다르거나 파티션 전략이 다를 경우 조인을 수행할 수 없다
      - 코파티셔닝이 되지 않은 2개의 토픽을 조인하는 로직이 담긴 스트림즈 애플리케이션을 실행하면 TopologyException 이 발생
      - 리파티셔닝 과정을 거쳐 KStream, KTable로 사용하는 토픽이 코파티셔닝되도록 할 수 있다
    - GlobalKTable은 코파티셔닝되지 않은 KStream과 데이터 조인을 할 수 있다
      - KTable과 다르게 GlobalKTable로 정의된 데이터는 스트림즈 애플리케이션의 모든 태스크에 동일하게 공유되어 사용되기 때문이다
    - GlobalKTable은 각 태스크마다 모든 데이터를 저장하기 때문에 스토리지 사용량 증가, 네트워크, 브로커 부하등에 단점이 있기 때문에 많은 양의 데이터를 가진 토픽으로 조인하는 경우 리파티셔닝을 통한 KTable 사용 권장

- 주요 옵션
  - bootstrap.servers
    - 카프카 클러스터에 속한 브로커의 호스트 이름: 포트를 1개 이상 작성
  - application.id
    - 스트림즈 애플리케이션을 구분하기 위한 고유 아이디 설정
  - default.key.serde
    - 레코드의 메시지 키 직렬화/역직렬화하는 클래스 지정
    - 기본값은 Serdes.ByteArray().getClass().getName 이다
  - default.value.serde
    - 레코드의 메시지 값 직렬화/역직렬화하는 클래스 지정
    - 기본값은 Serdes.ByteArray().getClass().getName 이다
  - num.stream.threads
    - 스트림 프로세싱 실행 시 실행될 스레드 개수 지정
  - state.dir
    - rocksDB 저장소 위치할 디렉토리 지정
    - 카프카 스트림즈 상태기반 데이터를 처리할 때 로컬 저장소로 사용
    - 기본값으로는 tmp/kafka-streams 이다

- 주요 메서드
  - stream(), to()
  - filter()
  - join()
    - KTable, KStream
    - GlobalKTable, KStream

#### 프로세서 API
