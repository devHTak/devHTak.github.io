---
layout: post
title: Kafka - 운영 시 고려사항
summary: Kafka
author: devhtak
date: '2022-10-31 14:41:00 +0900'
category: mq
---

#### 토픽과 파티션

- 적정 파티션 개수
  - 데이터 처리량
    - 데이터 처리를 올리기 위해서는 컨슈머의 처리량을 늘리거나 컨슈머를 추가하여 병렬처리량을 늘리는 것
    - 파티션 개수만큼 컨슈머 스레드를 운영한다면 해당 토픽의 병렬처리를 극대화할 수 있다
      - 만약 전체 컨슈머 데이터 처리량이 프로듀서가 보내는 데이터보다 적다면 컨슈머 랙이 생기고, 데이터 처리 지연 발생
  - 메시지 키를 사용
    - 메시지 키 사용 여부와 관련해서는 메시지 키를 사용함과 동시에 데이터 처리 순서를 지켜야하는 경우 고려
    - 프로듀서가 토픽으로 데이터를 보낼 때 메시지 키를 해시 변환하여 메시지 키를 파티션에 매칭하기 때문에 파티션 개수가 달라지면 매칭된 파티션과 메시지 키 매칭이 깨지고 다른 파티션에 할당된다
    - 메시지 키를 사용하여 순서 보장되어야 한다면 최대한 파티션 변화는 일어나지 않도록 해야 하며 변화가 필요한 경우 커스텀 파티셔너를 개발하여 적용해야 한다
  - 브로커, 컨슈머 영향도
    - 카프카에서 파티션은 각 브로커와 파일 시스템을 사용하기 때문에 파티션이 늘어나는 만큼 브러커에서 접근하는 파일 개수가 많아진다
    - 운영체제에서는 프로세스 당 열 수 있는 파일 최대 개수를 제한하고 있기 때문에 안정적으로 유지할 수 있는 브로커 당 파티션 개수를 모니터링 해야 한다

- 토픽 정리 정책 (cleanup.policy)
  - 토픽의 데이터는 시간 또는 용량에 따라 삭제 규칙을 적용할 수 있다
  - 클라우드를 활용하는 경우 저장소 용량이 늘어남에 따라 비용도 함께 늘어나기 때문에 삭제 정책을 지정할 필요가 있다
  - cleanup.policy: delete (삭제)
    - segment.bytes 옵션
      - 세그먼트는 토픽의 데이터를 저장하는 명시적인 파일 시스템 단위
      - 1개의 세그먼트 크기를 지정
    - retention.ms 옵션
      - 토픽 데이터의 유지하는 기간을 밀리초 단위로 지정할 수 있다
    - retention.bytes 옵션
      - 지정한 크기를 넘어간 세그먼트 파일 삭제
      
  - cleanup.policy: compact (압축)
    - zip, tar 압축과는 다른 개념
    - 여기에서 압축이란 메시지 키별로 해당 메시지 키의 레코드 중 오래된 데이터를 삭제하는 정책을 뜻한다
      - 1개 파티션에서 오프셋의 증가가 일정하지 않ㅇ르 수 있다
      - KTable과 같이 메시지 키를 기반으로 데이터를 처리할 경우 유용
      - 데이터의 흐름이 아닌 가장 마지막으로 업데이트 된 메시지 키의 데이터가 중요할 경우 가장 최신의 데이터를 제외한 나머지 데이터를 삭제할 수 있다
    - min.cleanable.dirty.ratio 옵션
      - 데이터의 압축 시작 시점은 min.cleanable.dirty.ratio 옵션값을 따른다
      - 세그먼트에 남아 있는 데이터 테일 여역의 레코드 개수와 헤드 영역의 레코드 개수의 비율을 뜻한다
      - 테일 영역의 레코드들은 클린 로그라고 부르고 압축이 완료됐기 때문에 테일 영역에는 중복된 메시지 키가 없다
      - 헤드 영역의 레코드들은 더티 로그라고 부르고 압축이 되기 전 레코드들이 있으므로 중복된 메시지 키를 가진 레코드들이 있다
      - 더티 비율: 더티 영역의 메시지 개수를 압축 대상 세그먼트에 남아있는 데이터의 총 레코드 수로 나눈 비율을 뜻한다
        - 더티 레코드 개수 / (클린 레코드 개수 + 더티 레코드 개수)
        - 더티 비율을 너무 작게 설정하면 압축이 더 자주 일어나기 때문에 계속해서 메시지 키의 최신 데이터만 유지할 수 있다

- ISR (In-Sync-Replicas)
  - ISR은 리더 파티션과 팔로워 파티션이 모두 싱크가 된 상태(동기화 완료)를 뜻한다
  - 팔로워 파티션이 리더 파티션으로부터 데이터를 복제하는 데 시간이 걸린다
  - replica.lag.time.max.ms 옵션
    - 설정한 옵션값만큼 데이터를 복제하는 지 확인
    - 더 긴 시간동안 데이터를 가져가지 않는다면 해당 팔로워 파티션에 문제가 생긴것으로 간주하여 ISR 그룹에서 제외
  - unclean.leader.election.enable 옵션
    - ISR 에서 제외된 파티션은 리더 파티션으로 선출될 수 없는 데, 해당 옵션을 true로 하는 경우 동기화가 되지 않은 팔로우 파티션도 리더로 선출될 수 있다
    - true에 경우 리더 파티션을 선출할 수 없는 경우 리더 파티션이 존재하는 브로커가 다시 시작할 때까지 기다리며, 그 동안 서비스가 중단된다

- 토픽 옵션 설정
  ```
  bin/kafka-topic.sh --bootstrap-server my-kafka:9092 \
  --create --topic my-topic \
  -- config unclean.leader.election.enable=false
  ```

#### 카프카 프로듀서

#### 카프카 컨슈머

#### 출처

- 아파치 카프카 애플리케이션 프로그래밍 with 자바 책 발췌
