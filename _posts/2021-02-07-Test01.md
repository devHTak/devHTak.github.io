---
layout: post
title: 더 자바 테스트1. JUnit
summary: HTTP 완벽 가이드
author: devhtak
date: '2021-02-07 21:41:00 +0900'
category: 더 자바, 애플리케이션을 테스트하는 다양한 방법
---

#### JUnit 5

- 자바 개발자가 가장 많이 사용하는 테스팅 프레임워크
- Java 8 이상을 필요로 한다.
- 대체제로 TestNG, Spock 등이 있다.
- 구성
  - Platform: JUnit으로 작성한 테스트 코드를 실행해주는 런처 제공, TestEngine API 제공
  - Jupiter: TestEngine API 구현체로 JUnit5 제공
  - Vintage: JUnit3, 4를 지원하는 TestEnging 구현체

- 참고: https://junit.org/junit5/docs/current/user-guide/

#### JUnit 5 시작하기

- Spring Boot 2.2+ 이상의 프로젝트를 만든다면 기본으로 JUnit5 의존성이 추가된다.
- JUnit4까지는 class, test method가 모두 public 접근지시자야 했지만 JUnit5 부터는 class, test method가 default 접근지시자여도 괜찮다.
- dependency 추가
  ```
  <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter-engine</artifactId>
      <version>5.5.2</version>
      <scope>test</scope>
  </dependency>
  ```
- 기본 애노테이션
  - @Test
    - 테스트 메소드에 붙여준다.
  - @BeforeAll / @AfterAll
    - static void로 작성해야 한다. 
    - 접근 지시자는 private은 안되고, 나머지는 가능하다.
    - 테스트 코드가 시작되기 전, 후에 한번씩 실행된다.
  - @BeforeEach / @AfterEach
    - 접근 지시자는 private은 안되고, 나머지는 가능하다.
    - 테스트 메소드가 시작하기 전, 후에 각각 실행된다.
  - @Disabled
    - 테스트를 실행하고 싶지 않은 경우에 사용한다.
  
  ```java
  public class StudyTest {	
      @BeforeAll
      static void beforeAll() {
          System.out.println("beforeAll");
      }
      @AfterAll
      static void afterAll() {
          System.out.println("afterAll");
      }
      @BeforeEach
      void beforeEach() {
          System.out.println("beforeEach");
      }
      @AfterEach
      void afterEach() {
          System.out.println("afterEach");
      }
      @Test
      void createInstance() {
          Study study = new Study();
          assertNotNull(study);
      }
      @Test
      void sampleTest() {
          System.out.println("Hello JUnit5");
      }
  }
  ```
  ```
  // 출력 화면
  beforeAll
  beforeEach
  Hello JUnit5
  afterEach
  beforeEach
  afterEach
  afterAll
  ```

#### 테스트 이름 표시하기

- @DisplayNameGeneration
  - Mehtod와 Class 레퍼런스를 사용해서 테스트 이름을 표기하는 방법 설정
  - 기본 구현체로 ReplaceUnderscores 제공
  
- @DisplayName
  - 어떤 테스트인지 테스트 이름을 보다 쉽게 표현할 수 있는 방법을 제공하는 애노테이션
  - @DisplayNameGeneration 보다 우선 순위가 높다.
  
```java
@DisplayNameGeneration(DisplayNameGenerator.ReplaceUnderscores.class)
public class StudyTest {
    @Test
    @DisplayName("스터디_만들기")
    void test() {
        System.out.println("test");
    }
}
```
  - @DisplayNameGeneration(DisplayNameGenerator.ReplaceUnderscores.class)
    - create_instance를 create instance로 보이게 한다.
  
- 참고: https://junit.org/junit5/docs/current/user-guide/#writing-tests-display-names

#### Assertion

- Assertion 메소드
  - 패키지: org.junit.jupiter.api.Assertions.*
  
  |메소드|설명|
  |---|---|
  |assertEquals(expected, actual)|실제 값이 기대한 값과 같은지 확인|
  |assertNotNull(actual)|값이 null이 아닌지 확인|
  |assertTrue(boolean)|다음 조건이 참(true)인지 확인|
  |assertAll(excutables...)|모든 확인 구문 확인|
  |assertThrows(expectedTyupe, excutable)|예외 발생 확인|
  |assertTimeout(duration, excutable)|특정 시간 안에 실행이 완료되는지 확인|
  
  - 파라미터의 순서는 보통은 기대값, 비교하고자 하는 값을 입력한다. 
  
- 마지막 매개변수로 Supplier<String> 타입의 인스턴스를 람다 형태로 제공할 수 있다.
  - 복잡한 메시지 생성해야 하는 경우 사용하면 실패한 경우에만 해당 메시지를 만들게 할 수 있다.
- 다른 다양한 라이브러리를 사용할 수 있다.
  - AssertJ: https://joel-costigliola.github.io/assertj
    ```java
    assertThat(study.getLimit()).isGreaterThan(10);
    ```
  - Hemcrest: https://hamcrest.org/JavaHamcrest/
  - Truth: https://truth.dev/

```java
@Test
void create_instance() {
    Study study = new Study();
    assertNotNull(study);
    assertEquals(StudyStatus.DRAFT, study.getStatus(), new Supplier<String>() {
        @Override
        public String get() {
            // TODO Auto-generated method stub
            return null;
        }			
    }); //lambda 변환 가능 () -> "message";

    assertTrue(study.getLimit() >= 0, () -> "스터디 최소 참가자는 0 이상이어야 합니다.");

    assertAll(
        ()-> assertNotNull(study),
        ()-> assertEquals(StudyStatus.DRAFT, study.getStatus()),
        ()-> assertTrue(study.getLimit() >= 0, () -> "스터디 최소 참가자는 0 이상이어야 합니다.")
    );

    Exception e = assertThrows(IllegalArgumentException.class, ()-> study.setLimit(-10));
    assertEquals("limit은 0 이상이어야 한다.", e.getMessage());

    assertTimeout(Duration.ofMillis(100), ()->{
        new Study();
        Thread.sleep(1000);
    });

    assertTimeoutPreemptively(Duration.ofMillis(100), ()->{
        new Study();
        Thread.sleep(1000);
    });
}
```
- assertAll은 여러 assertion을 람다식으로 구현하여 한번에 테스트할 수 있다.
- assertThrows는 발생한 Exception 을 리턴한다.
- assertTimeout은 excutable이 완료될 때까지 기다린 후에 완료되기 때문에, 시간이 오래 걸린다.
  - assertTimeoutPreemptively(duration, excutable)
    - 정해놓은 Duration만큼만 기다리고 실패하면 바로 끝낸다.
    - 별도의 thread를 만들어 사용한다.
    - ThreadLocal(Spring Transaction 등)을 사용하면 예상치 못한 결과를 얻을 수 있다.
    - 다른 스레드에서 ThreadLocal이 공유되지 않기 때문에 트랜잭션 설정이 제대로 안될 수 있다. 기본 rollback인데 commit이 될 수도 있다.
    - 이 동작은 executable 또는 내부에서 실행되는 코드가 스토리지에 supplier의존 하는 경우 바람직하지 않은 부작용을 초래할 수 있다.

#### 조건에 따라 테스트 실행하기

- 특정한 조건을 만족하는 경우에 테스트를 실행하는 방법.
- org.junit.jupiter.api.Assumptions.*
  - assumeTrue(조건)
    - 조건이 참이면 아래 라인에 테스트를 마저 진행하고, 거짓인 경우에 중단된다.
    - assumeTrue가 실패하면 Assumption failed: assumption is not true 라는 메시지와 함께 테스트가 더이상 진행되지 않는다.
      ```java
      @Test
      @DisplayName("스터디 만들기")
      void create_new_study() {
          String testenv = System.getenv("testenv");
          assumeTrue("LOCAL".equalsIgnoreCase(testenv));

          Study actual = new Study();
          assertNotNull(actual);

          actual.setLimit(10);
          assertEquals(10, actual.getLimit());
      }
      ```
    - 환경변수 실행 방법
      - System.getenv 는 환경변수를 가져올 수 있다.
      - cmd(window): set TEST_ENV="LOCAL"
      - linux: vim ~/.zhsrc 하여 export TEST_ENV=LOCAL 저장
  - assumeThat(조건, 테스트)
    - 조건이 참이면 lambda로 표현한 테스트를 실행한다.
    - 조건이 틀리더라도 테스트는 성공으로 표현된다.
      ```java
      @Test
      @DisplayName("스터디 만들기")
      void create_new_study() {
          String testenv = System.getenv("testenv");
          // assumeTrue("LOCAL".equalsIgnoreCase(testenv));

          assumingThat("LOCAL".equalsIgnoreCase(testenv), ()->{
            Study actual = new Study();
            assertNotNull(actual);

            actual.setLimit(10);
            assertEquals(10, actual.getLimit());
          });		
      }
      ```
  
- @Enabled__ 와 @Dsiabled__
  - @EnabledOnOS | @DisabledOnOs    
    - 운영체제에 대해 확인하여 조건에 맞게 실행 및 실행하지 않는다.
    - @EnabledOnOs(OS.MAC)
  - @EnabledOnJre | @DisabledOnJre
    - JRE 버전에 대해 확인하여 조건에 맞게 실행 및 실행하지 않는다.
    - @DisabledOnJre(JRE.JAVA_11)
  - @EnabledIfSystemProperty | @DisabledIfSystemProperty
    - 시스템 설정에 대해 확인하여 조건에 맞게 실행 및 실행하지 않는다.
    - @EnabledIfSystemProperty(named="testenv", matches="LOCAL")
  - @EnabledIfEnvironmentVariable | @DisabledIfEnvironmentVariable
    - 환경변수에 대해 확인하여 조건에 맞게 실행 및 실행하지 않는다.
    - @DisabledIfEnvironmentVariable(named="testenv", matches="LOCAL")
  - @EnabledIf | @DisabledIf
    - 조건에 맞으면 실행 및 실행하지 않는다.
  
#### 태깅과 필터링

- 테스트 그룹을 만들고 원하는 테스트 그룹만 테스트를 실행할 수 있는 기능
- @Tag
  - 테스트 메소드에 태그를 추가할 수 있다.
  - 하나의 테스트 메소드에 여러 태그를 사용할 수 있다.
  
- 메이븐에서 테스트 필터링 하는 방법
  ```
  <plugin>
      <artifactId>maven-surefire-plugin</artifactId>
      <configuration>
          <groups>fast|slow</groups>      
      </configuration>
  </plugin>
  ```

- 예제) fast로 태그한 것은 로컬환경에서 실행되고, slow로 태그한 것은 CI 후 배포 환경에서 실행되도록 하자
  - 테스트 태깅
    ```java
    @Test
    @DisplayName("스터디 만들기")
    @Tag("fast")
    void create_new_study() {
        Study actual = new Study();
        assertNotNull(actual);

        actual.setLimit(10);
        assertEquals(10, actual.getLimit());
    }

    @Test
    @DisplayName("스터디 만들기")
    @Tag("slow")
    void test_timeout() {
        assertTimeout(Duration.ofMillis(1000), ()->{
            new Study();
            Thread.sleep(10000);
        });
    }
    ```
  
  - 메이븐 설정
    ```
    <profiles>
        <profile>
            <id>default</id>
            <activation>
                <activeByDefault>true</activeByDefault>
            </activation>
            <build>
                <plugin>
                    <artifactId>maven-surefire-plugin</artifactId>
                    <configuration>
                        <groups>fast</groups>      
                    </configuration>
                </plugin>
            </build>
        </profile>
        <profile>
            <id>ci</id>
            <activation>
                <activeByDefault>true</activeByDefault>
            </activation>
            <build>
                <plugin>
                    <artifactId>maven-surefire-plugin</artifactId>
                </plugin>
            </build>
        </profile>
    </profiles>
    ```
    ```
    $ mvn test -P ci // profile에서 id가 ci인 환경을 참조하여 모든 테스트를 실행한다.
    $ mvn test // profile에서 id가 default인 환경을  참조하여 fast로 태깅된 테스트만 실행한다.
    ```
  
- 참고
  - https://maven.apache.org/guides/introduction/introduction-to-profiles.html
  - https://junit.org/junit5/docs/current/user-guide/#running-tests-tag-expressions

#### 커스텀 태그

- jUnit5 애노테이션을 조합하여 커스텀 태그를 만들 수 있다.
- 예제) fast, slow를 태깅한 애노테이션 만들기
  - FastTest.java
    ```java
    @Target(ElementType.METHOD)
    @Retention(RetentionPolicy.RUNTIME)
    @Tag("fast")
    @Test
    public @interface FastTest {}
    ```
  - SlowTest.java
    ```java
    @Target(ElementType.METHOD)
    @Retention(RetentionPolicy.RUNTIME)
    @Tag("slow")
    @Test
    public @interface SlowTest {}
    ```
  
  - 활용하기
    ```java
    @FastTest
    @DisplayName("스터디 만들기 fast")
    void create_new_study() {
        // ...
    }
    
    @SlowTest
    @DisplayName("스터디 만들기 slow")
    void create_new_study_again() {
        // ...
    }    
    ```
#### 테스트 반복하기

- @RepeatedTest
  - 반복 횟수와 반복 테스트 이름을 설정할 수 있다.
    - {displayName}
    - {currentRepetition}
    - {totalRepetitions{
  - RepetitionInfo 타입의 인자를 받을 수 있다.
  
- @ParameterizedTest
  - 테스트에 여러 다른 매개변수를 대입해가며 반복을 실행한다.
    - {displayName}
    - {index}
    - {arguments}
    - {0}, {1}, ...
    
- 인자 값들의 소스 
  - @ValueSource
  - @NullSource, @EmptySource, @NullAndEmptySource
  - @EnumSource
  - @MethodSource
  - @CvsSource
  - @CvsFileSource
  - @ArgumentSource
  
- 인자 값 타입 변환
  - 암묵적인 타입 변환
    - 레퍼런스 참고
  - 명시적인 타입 변환
    - SimpleArgumentConverter 상속 받은 구현체 제공
    - @ConverterWith
    
- 인자 값 조합
  - ArgumentAccessor
  - 커스텀 Accessor
    - ArgumentsAggregator 인터페이스 구현
    - @AggregateWith
    
- 참고
  - https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests
  









