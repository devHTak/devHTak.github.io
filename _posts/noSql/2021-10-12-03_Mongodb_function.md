---
layout: post
title: Mongodb - index, shading, replica
summary: JUnit 사용법
author: devhtak
date: '2021-10-11 21:41:00 +0900'
category: No SQL
---

#### Mongodb index

- index
  - index는 디비의 검색을 빠르게 하기 위해 미리 데이터의 순서를 정리해두는 과정
  - Mongodb는 고정된 스키마는 없지만 원하는 데이터 필드를 인덱스로 지정하여 검색 결과를 빠르게 하는 것이 가능
  - NOSQL 에서도 index를 잘 설계해야 최대의 효율이 가능
  - Mongodb는 B-Tree 구조로 index를 구현
  - 고유 index, 희소 index, 다중 키 index, 복합 index, 단일 index 지원

- index 개념
  - index는 도큐먼트를 쿼리해오기 위한 작업량을 줄인다
    - 적당한 index가 없으면 질의 조건을 만족할 때까지 모든 도큐먼트를 순차적으로 스캔
  - 한 쿼리당 하나의 index만 유효
  - 두 개의 index가 필요하다면 복합 index를 사용
    - a, b 필드로 구성된 복합 index를 가지고 있다면 a에 대해 단일 index는 제거해도 됨
    - 복합 index에서 키의 순서는 매우 중요
  - _id는 기본적으로 생성되는 index로 도큐먼트를 가르키는 유일한 키값으로 사용
    - 도큐먼트에 빠르게 접근하기 위해서 각 _id는 index로 관리
    
- 효율
  - 쿼리 성능 향상을 위해 무한히 index 를 추가하는 것은 불가능
  - 모든 index에는 결국 유지비가 소요됨
  - 어떤 데이터가 도큐먼트에 추가되거나 수정될 때마다 그 컬렉션에 대해 생성된 index도 그 새로운 도큐먼트를 포함시키도록 수정되어야 함
  - 최악의 경우에는 결국 데이터를 다시 정렬해야 하는 상황 발생
  - index는 읽기 위주의 어플리케이션에서 유용
  - 읽기보다 쓰기 작업이 많다면 어느 정도 index를 포기하거나 index를 위한 컬렉션을 따로 운영해야 함
  - Mongodb는 기동시 모든 데이터 파일을 메모리에 매핑함
  - 모든 도큐먼트, 컬렉션, 인덱스를 포함하는 모든 데이터 파일이 페이지(page)라고 부르는 4kb정도의 청크 단위로 운영체제에 의해 램에 적재
  - 램의 모든 데이터를 수용만 할 수 있다면 디스크 액세스 횟수 최소화 가능
  - 모든 데이터를 수용하지 못하면 페이지 폴트가 자주 발생하게 되고 운영체제가 디스크를 빈번하게 액세스하게 됨으로 인해 읽기/쓰기 연산 지연 발생
  - 스레싱(thrasing): 모든 데이터를 디스크에서 액세스해야 하는 경우 굉장한 성능 저하를 초래
  - 최소한의 인덱스가 메모리에 위치 할 수 있도록 최소화될 필요가 있음
  - 복합인덱스는 더 많은 공간을 필요로 함을 고려해야 함
  
- B-Tree
  

  - 트리구조와 유사한 데이터 구조
  - 각 노드는 여러 개의 키를 갖는 것이 가능
  - Mongodb에서 사용하는 B-Tree는 새 노드에 대해 8192바이트를 할당함
    - 각 노드가 수백개의 키를 가질 수 있다.
  - 인덱스 키의 평균 크기에 따라 달라질 수도 있는데, 보통 키의 평균적인 크기는 30바이트 안팎임
  - 특징
    - 정확한 일치, 범위 조건, 정렬, 프리픽스 일치 등 다양한 쿼리를 용이하게 처리하도록 도와준다
    - 키가 추가되거나 삭제되더라도 밸런스 유지에 좋다
    
  

  
  
