---
layout: post
title: Netty. Codec(feat. Netty in action)
summary: 네트워크 프로그래밍
author: devhtak
date: '2022-02-04 22:41:00 +0900'
category: java
---

#### chap 10. 코덱 프레임워크

##### 코덱이란
- 모든 네트워크 어플리케이션은 피어 간에 전송되는 원시 바이트를 대상 프로그램의 데이터 포맷으로 구문 분석하고 변환하는 방법을 정의해야 한다
- 이러한 변환은 인코더와 디코더로 구성된 코덱애 의해 처리
- 인코더는 메시지를 전송하기에 적합한 형식(대부분 바이트 스트림)으로 변환
- 디코더는 네트워크 스트림을 다시 프로그램의 메시지 포맷으로 변환

##### 디코더
- 인바운드 데이터를 ChannelPipelines 내에 ChannelInboundHandler를 위해 변환할 때 이용

- ByteToMessageDecoder(바이트 스트림을 메시지로 디코딩)
```java
public class ToIntegerDecoder extends ByteToMessageDecoder {
    @Override
    public void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {
        if(in.readByes() >= 4) {
            out.add(in.readInt());
        }
    }
}
```
  - 바이트 스트림을 메시지로 디코딩하는 작업
  - 원격 피어가 완성된 메시지를 한번에 보낼지는 알 수 없으므로 이 클래스는 인바운드 데이터가 처리할 만큼 모일 떄까지 버퍼에 저장
  - 메서드 1. decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out)
    - 구현해야 하는 유일한 추상 메서드로서 들어오는 데이터가 포함된 ByteBuf와 디코딩된 메시지가 추가될 List를 받는다
    - 이 호출은 더 이상 List에 추가할 새로운 항목이 없거나 ByteBuf 에 읽을 바이트가 없을 때까지 반복
    - 그 이후 List가 비어 있지 않은 경우 그 내용이 파이프라인의 다음 핸들러로 전달
  - 메서드 2. decodeLast(ChannelHandlerContext ctx, ByteBuf buf, List<Object> out)
    - Channel이 비활성화될 때 한번 호출된다 
- ReplayingDecoder(바이트 스트림을 메시지로 디코딩)
  - ByteToMessageDecoder 를 확장하며, readableBytes() 메서드를 호출할 필요를 없애준다.
  - 이를 위해 들어오는 ByteBuf 를 커스텀 ByteBuf 구현인 ReplayingDecoderBuffer로 매핑하여 내부적으로 호출 수행
  - ReplayingDecoderBuffer
    - 모든 ByteBuf 작업이 지원되는 것은 아니며 지원되지 않는 메서드를 호출하면 UnsupportedOperationException 발생
    - ReplayingDecoder 는 ByteToMessageDecoder 보다 약간 느리다

- MesssageToMessageDecoder<I>(메시지를 다른 메시지 유형으로 디코딩)
```java
public class IntegerToStringDecoder extends MessageToMessageDecoder<Integer> throws Exception {
      @Override
      public void decode(ChannelHandlerContext ctx, Integer in, List<Object> out) {
          out.add(String.valueOf(in));
      }
}
```
  - decode(ChannelHandlerContext ctx, I msg, List<Object> out)
    - 인바운드 메시지를 다른 포맷으로 디코딩할 때마다 호출. 디코딩된 메시지는 파이프라인의 다음 ChannelInboundHandler로 전달
  
- HttpObjectDecoder, LineBasedFrameDecoder 등 다양한 디코더등이 존재

- TooLongFrameException
  - 디코딩할 수 있을때까지 바이트를 메모리 버퍼에 저장해야 하는데, 디코더가 메모리를 소진할 만큼 많은 데이터를 저장하지 않게 해야 한다
  - 지정한 크기를 초과하면 발생하는 TooLongFrameException 발생

##### 인코더
- ChannelOutboundHandler 를 구현하고 아웃바운드 데이터를 다른 포맷으로 변환한다
- MessageToByteEncoder<I>
  - encode(ChannelHandlerContext ctx, I msg, ByteBuf out)
    - encode 메서드는 구현해야 하는 유일한 추상 메서드이며, ByteBuf 로 인코딩할 아웃바운드 메시지를 전달하고 호출한다.
    - 그런 다음 ByteBuf 는 파이프라인 내의 대음 ChannelOutboundHandler로 전달
  ```java
  public class ShortToByteEncoder extends MessageToByteEncoder<Short> {
        @Override
        public void encode(ChannelHandlerContext ctx, Short msg, ByteBuf out) throws Exception {
            out.write(msg);
        }
  } 
  ```
- MessageToMessageEncoder<I>
```java
public class IntegerToStringEncoder extends MessageToMessageEncoder<Integer> {
    @Override
    public void encode(ChannelHandlerContext ctx, Integer msg, List<Object> out) throws Exception {
        out.add(String.valueOf(msg));
    }
}
```
  - encode(ChannelHandlerContext ctx, I msg, List<Object> out)
    - encode()는 구현해야 하는 유일한 메서드로 write() 로 기록한 메시지는 encode()로 전달된 후 하나 이상의 아웃바운드 메시지로 인코딩
    - 그런 다음 파이프라인 내의 다음 ChannelOutboundHandler 로 전달

##### 추상 코덱 클래스
